<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas Mary</title>
    <!-- Agregar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Scripts necesarios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <!-- Agregar Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Agregar Moment.js para manejo de fechas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/es.js"></script>

    <style>
        /* Fuentes personalizadas */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600&display=swap');

        body { 
            font-family: 'Poppins', sans-serif; 
            padding: 20px; 
            background-color: #FFF0F5; 
            margin: 0; 
            color: #333;
            background-image: url('https://www.transparenttextures.com/patterns/soft-circle-scales.png');
        }
        .container { 
            max-width: 500px; 
            margin: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: linear-gradient(to bottom right, #FFFFFF, #FFE4E1);
            position: relative;
            overflow: hidden;
        }
        h2 { 
            text-align: center; 
            color: #8B4513; 
            font-family: 'Dancing Script', cursive;
            font-size: 3rem;
            margin: 0;
            padding: 20px 0;
            position: relative;
            z-index: 2;
        }
        h2::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: -1;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        input, button { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #FFB6C1;
        }
        button { 
            background-color: #FF69B4; 
            color: white; 
            border: none; 
            transition: background-color 0.3s ease;
        }
        button:hover { 
            background-color: #FF1493; 
        }

        .menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #FF69B4;
            border-radius: 50%;
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 250px;
            background: linear-gradient(to bottom, #FF69B4, #8B008B);
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            z-index: 999;
            color: white;
        }

        .sidebar.open { transform: translateX(0); }
        .sidebar h3 { 
            color: white; 
            font-family: 'Georgia', serif;
            text-align: center;
        }
        .sidebar ul { 
            list-style: none; 
            padding: 0; 
        }
        .sidebar ul li { 
            margin: 15px 0; 
            text-align: center;
        }
        .sidebar ul li button { 
            width: 100%; 
            background: none; 
            color: white; 
            border: 2px solid white; 
            cursor: pointer; 
            transition: background-color 0.3s ease;
        }
        .sidebar ul li button:hover {
            background-color: rgba(255,255,255,0.2);
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background: linear-gradient(to bottom right, #FFE4E1, #FFB6C1);
            margin: 15% auto;
            padding: 20px;
            border: 2px solid #FF69B4;
            width: 80%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .close {
            color: #FF1493;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .resumen {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .resumen h3 {
            color: #8B4513;
            margin-bottom: 15px;
        }

        .resumen ul {
            list-style-type: none;
            padding-left: 0;
        }

        .resumen li {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #FFB6C1;
        }

        .edit-button {
            background-color: #FF69B4;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        .edit-button:hover {
            background-color: #FF1493;
        }

        .clienta-pedido {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(255, 182, 193, 0.2);
            border: 1px solid #FFB6C1;
        }

        .clienta-pedido:last-child {
            margin-bottom: 0;
        }

        /* Estilos para los stickers */
        .sticker {
            position: absolute;
            z-index: 1;
            opacity: 0.8;
        }
        .sticker.pintauñas {
            top: 10px;
            left: 10px;
            width: 60px;
        }
        .sticker.pintauñas-derecha {
            bottom: 10px;
            right: 10px;
            width: 60px;
        }

        /* Estilos para el botón de WhatsApp */
        button.enviar-whatsapp {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        button.enviar-whatsapp:hover {
            background-color: #128C7E;
        }

        /* Estilos para las estadísticas */
        .estadisticas-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #FFE4E1, #FFB6C1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #8B4513;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            margin: 20px 0;
            height: 300px;
        }

        .chart-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .chart-selector button {
            background: #FF69B4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .chart-selector button.active {
            background: #FF1493;
        }

        .date-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            align-items: center;
        }

        .date-selector button {
            background: none;
            border: 2px solid #FF69B4;
            color: #FF69B4;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-selector button:hover {
            background: #FF69B4;
            color: white;
        }

        /* Estilos para los separadores */
        .separator {
            height: 1px;
            background-color: #FFB6C1;
            margin: 15px 0;
            opacity: 0.5;
        }

        /* Estilos para los campos adicionales */
        .additional-fields {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px dashed #FFB6C1;
        }

        .field-label {
            font-size: 0.9rem;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .stat-sublabel {
            color: #8B4513;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Stickers decorativos -->
    <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" alt="Pintauñas" class="sticker pintauñas">
    <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" alt="Pintauñas" class="sticker pintauñas-derecha">

    <button class="menu-btn" onclick="toggleSidebar()">☰</button>

    <div class="sidebar" id="sidebar">
        <h3>Menú de Ventas</h3>
        <ul>
            <li><button onclick="irAInicio()">Inicio</button></li>
            <li><button onclick="mostrarResumen()">Ver Totales</button></li>
            <li><button onclick="abrirModalEstadisticas()">Estadísticas de Ventas</button></li>
            <li><button onclick="abrirModalBuscarClienta()">Buscar Clienta</button></li>
            <li><button onclick="abrirModalRegistrarClienta()">Registrar Clienta</button></li>
            <li><button onclick="abrirModalVerClientas()">Ver Clientas Registradas</button></li>
            <li><button onclick="verProductosYClientas()">Ver Productos y Clientas</button></li>
            <li><button onclick="generarPDF()">Generar PDF de Pedidos</button></li>
            <li><button onclick="confirmarReiniciarInventario()">Reiniciar Inventario</button></li>
        </ul>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <div id="modal-contenido"></div>
        </div>
    </div>

    <div class="container">
        <h2>Ventas Mary</h2>

        <div id="producto-form">
            <input type="text" id="nombreProducto" placeholder="Nombre del producto">
            <input type="number" id="precioProducto" placeholder="Precio del producto">
            <button onclick="agregarProducto()">Agregar Producto</button>
        </div>

        <div id="cliente-form" style="display:none;">
            <input type="text" id="nombreClienta" placeholder="Nombre de la clienta: ">
            
            <!-- Nuevos campos para color y cantidad -->
            <div class="additional-fields">
                <div class="field-label">Detalles adicionales (opcionales):</div>
                <input type="text" id="colorProducto" placeholder="Color del producto (opcional)">
                <input type="number" id="cantidadProducto" placeholder="Cantidad" min="1" value="1">
            </div>
            
            <button onclick="agregarCliente()">Agregar Clienta</button>
            <button onclick="finalizarProducto()">Finalizar Producto</button>
        </div>

        <div class="resumen" id="resumen"></div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrr78dgKymDyjxgZitGq0QLddCy8thkXU",
            authDomain: "ventasmary-f0aa0.firebaseapp.com",
            databaseURL: "https://ventasmary-f0aa0-default-rtdb.firebaseio.com",
            projectId: "ventasmary-f0aa0",
            storageBucket: "ventasmary-f0aa0.firebasestorage.app",
            messagingSenderId: "45177270937",
            appId: "1:45177270937:web:040e6c5f0f8c7233cf3e08",
            measurementId: "G-GZ5LH02RS6"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales
        let pedidos = {};
        let clientasRegistradas = {};
        let productoActual = {};
        let estadisticasSemanales = {};
        let graficosEstadisticas = {};

        // Cargar datos iniciales
        function cargarDatos() {
            database.ref('pedidos').on('value', (snapshot) => {
                pedidos = snapshot.val() || {};
                mostrarResumen();
            });

            database.ref('clientasRegistradas').on('value', (snapshot) => {
                clientasRegistradas = snapshot.val() || {};
            });

            database.ref('estadisticasSemanales').on('value', (snapshot) => {
                estadisticasSemanales = snapshot.val() || {};
            });
        }

        // Llamar a cargarDatos cuando se inicia la aplicación
        cargarDatos();

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function abrirModal(contenido) {
            document.getElementById('modal-contenido').innerHTML = contenido;
            document.getElementById('modal').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function irAInicio() {
            document.getElementById('resumen').innerHTML = '';
            document.getElementById('producto-form').style.display = 'block';
            document.getElementById('cliente-form').style.display = 'none';
        }

        function agregarProducto() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precio = parseInt(document.getElementById('precioProducto').value);

            if (nombre && precio > 0) {
                productoActual = { nombre: nombre, precio: precio };
                document.getElementById('producto-form').style.display = 'none';
                document.getElementById('cliente-form').style.display = 'block';
            } else {
                alert('Por favor, ingrese un nombre y precio válido para el producto.');
            }
        }

        function agregarCliente() {
            const entrada = document.getElementById('nombreClienta').value.trim();
            if (entrada) {
                let partes = entrada.split(' ');
                let cantidad = parseInt(document.getElementById('cantidadProducto').value) || 1;
                let nombreClienta;

                // Si el último elemento es un número, usarlo como cantidad (compatibilidad con versión anterior)
                if (!isNaN(partes[partes.length - 1])) {
                    const cantidadTexto = parseInt(partes.pop());
                    // Solo usar la cantidad del texto si no se especificó en el campo de cantidad
                    if (cantidad === 1 && cantidadTexto > 1) {
                        cantidad = cantidadTexto;
                    }
                    nombreClienta = partes.join(' ');
                } else {
                    nombreClienta = entrada;
                }

                nombreClienta = nombreClienta.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                if (!pedidos[nombreClienta]) {
                    pedidos[nombreClienta] = [];
                }

                // Obtener el color (opcional)
                const color = document.getElementById('colorProducto').value.trim();

                // Crear el objeto de pedido con los nuevos campos
                const nuevoPedido = {
                    producto: productoActual.nombre,
                    precio: productoActual.precio,
                    cantidad: cantidad
                };

                // Agregar el color solo si se especificó
                if (color) {
                    nuevoPedido.color = color;
                }

                pedidos[nombreClienta].push(nuevoPedido);

                // Limpiar los campos
                document.getElementById('nombreClienta').value = '';
                document.getElementById('colorProducto').value = '';
                document.getElementById('cantidadProducto').value = '1';
                
                // Guardar en Firebase
                database.ref('pedidos').set(pedidos);
            } else {
                alert('Ingrese el nombre completo de la clienta.');
            }
        }

        function finalizarProducto() {
            document.getElementById('nombreProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('producto-form').style.display = 'block';
            document.getElementById('cliente-form').style.display = 'none';
        }

        function mostrarResumen() {
            let resumen = '<h3>Resumen de Pedidos:</h3>';
            for (let clienta in pedidos) {
                let total = 0;
                resumen += `<div class="clienta-pedido"><strong>${clienta}</strong><ul>`;
                pedidos[clienta].forEach((pedido) => {
                    let subtotal = pedido.precio * pedido.cantidad;
                    total += subtotal;
                    
                    // Mostrar el color si existe
                    const colorInfo = pedido.color ? ` (${pedido.color})` : '';
                    
                    resumen += `<li>${pedido.producto}${colorInfo}: ${pedido.cantidad} x $${pedido.precio} = $${subtotal}</li>`;
                });
                resumen += `</ul><strong>Total: $${total}</strong></div>`;
            }
            document.getElementById('resumen').innerHTML = resumen;
        }

        function abrirModalRegistrarClienta() {
            const contenido = `
                <h3>Registrar Clienta</h3>
                <input type="text" id="nombreClientaRegistro" placeholder="Nombre de la clienta">
                <input type="text" id="telefonoClientaRegistro" placeholder="Número de teléfono">
                <button onclick="registrarClienta()">Registrar</button>
            `;
            abrirModal(contenido);
        }

        function registrarClienta() {
            const nombre = document.getElementById('nombreClientaRegistro').value.trim();
            let telefono = document.getElementById('telefonoClientaRegistro').value.trim();

            if (nombre && telefono) {
                telefono = telefono.replace(/\D/g, '');
                
                if (telefono.length === 10) {
                    clientasRegistradas[nombre] = telefono;
                    // Guardar en Firebase
                    database.ref('clientasRegistradas').set(clientasRegistradas);
                    cerrarModal();
                    alert('Clienta registrada correctamente.');
                } else {
                    alert('Por favor, ingrese un número de teléfono válido de 10 dígitos.');
                }
            } else {
                alert('Por favor, ingrese el nombre y el número de teléfono de la clienta.');
            }
        }

        function abrirModalVerClientas() {
            let contenido = '<h3>Clientas Registradas</h3>';
            if (Object.keys(clientasRegistradas).length > 0) {
                contenido += '<ul>';
                for (let nombre in clientasRegistradas) {
                    contenido += `
                        <li>
                            <strong>${nombre}</strong>: ${clientasRegistradas[nombre]}
                            <button class="edit-button" onclick="abrirModalEditarClienta('${nombre}')">Editar</button>
                            <button class="edit-button" onclick="eliminarClienta('${nombre}')">Eliminar</button>
                        </li>
                    `;
                }
                contenido += '</ul>';
            } else {
                contenido += '<p>No hay clientas registradas.</p>';
            }
            abrirModal(contenido);
        }

        function abrirModalEditarClienta(nombre) {
            const contenido = `
                <h3>Editar Clienta</h3>
                <input type="text" id="nombreClientaEditar" value="${nombre}" placeholder="Nombre de la clienta">
                <input type="text" id="telefonoClientaEditar" value="${clientasRegistradas[nombre]}" placeholder="Nuevo número de teléfono">
                <button onclick="editarClienta('${nombre}')">Guardar Cambios</button>
            `;
            abrirModal(contenido);
        }

        function editarClienta(nombreAnterior) {
            const nombre = document.getElementById('nombreClientaEditar').value.trim();
            let telefono = document.getElementById('telefonoClientaEditar').value.trim();

            if (nombre && telefono) {
                telefono = telefono.replace(/\D/g, '');
                
                if (telefono.length === 10) {
                    if (clientasRegistradas[nombreAnterior]) {
                        delete clientasRegistradas[nombreAnterior];
                        clientasRegistradas[nombre] = telefono;
                        // Actualizar Firebase
                        database.ref('clientasRegistradas').set(clientasRegistradas);
                        cerrarModal();
                        alert('Datos de la clienta actualizados correctamente.');
                    } else {
                        alert('No se encontró una clienta con ese nombre.');
                    }
                } else {
                    alert('Por favor, ingrese un número de teléfono válido de 10 dígitos.');
                }
            } else {
                alert('Por favor, ingrese el nombre y el nuevo número de teléfono de la clienta.');
            }
        }

        function eliminarClienta(nombre) {
            if (confirm(`¿Estás segura de que deseas eliminar a ${nombre} del registro?`)) {
                delete clientasRegistradas[nombre];
                // Actualizar Firebase
                database.ref('clientasRegistradas').set(clientasRegistradas);
                abrirModalVerClientas();
                alert('Clienta eliminada correctamente.');
            }
        }

        function abrirModalBuscarClienta() {
            const contenido = `
                <h3>Buscar Clienta</h3>
                <input type="text" id="buscarNombreClienta" placeholder="Nombre de la clienta">
                <button onclick="buscarClienta()">Buscar</button>
            `;
            abrirModal(contenido);
        }

        function buscarClienta() {
            const nombre = document.getElementById('buscarNombreClienta').value.trim();
            if (pedidos[nombre]) {
                let resultado = `<div class="clienta-pedido">
                    <h3>Pedidos de ${nombre}:</h3>
                    <button class="edit-button" onclick="editarNombreClienta('${nombre}')">Editar Nombre</button>
                    <ul>`;
                let total = 0;
                pedidos[nombre].forEach((pedido, index) => {
                    let subtotal = pedido.precio * pedido.cantidad;
                    total += subtotal;
                    
                    // Mostrar el color si existe
                    const colorInfo = pedido.color ? ` (${pedido.color})` : '';
                    
                    resultado += `<li>${pedido.producto}${colorInfo}: ${pedido.cantidad} x $${pedido.precio} = $${subtotal}
                        <button class="edit-button" onclick="editarPedido('${nombre}', ${index})">Editar</button></li>`;
                });
                resultado += `</ul><strong>Total: $${total}</strong>`;

                if (clientasRegistradas[nombre]) {
                    resultado += `<button class="enviar-whatsapp" onclick="enviarWhatsApp('${nombre}')">Enviar pedido por WhatsApp</button>`;
                } else {
                    resultado += `<p style="color: red;">No hay número registrado para esta clienta.</p>`;
                }

                resultado += `</div>`;
                document.getElementById('modal-contenido').innerHTML = resultado;
            } else {
                document.getElementById('modal-contenido').innerHTML = '<p>No se encontraron pedidos para esta clienta.</p>';
            }
        }

        function editarNombreClienta(nombreAntiguo) {
            const contenido = `
                <h3>Editar Nombre de Clienta</h3>
                <input type="text" id="nuevoNombreClienta" value="${nombreAntiguo}" placeholder="Nuevo nombre de la clienta">
                <button onclick="guardarNuevoNombre('${nombreAntiguo}')">Guardar Nuevo Nombre</button>
            `;
            abrirModal(contenido);
        }

        function guardarNuevoNombre(nombreAntiguo) {
            const nuevoNombre = document.getElementById('nuevoNombreClienta').value.trim();
            
            if (nuevoNombre && nuevoNombre !== nombreAntiguo) {
                const nombreFormateado = nuevoNombre.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');

                if (pedidos[nombreFormateado]) {
                    pedidos[nombreFormateado] = pedidos[nombreFormateado].concat(pedidos[nombreAntiguo]);
                    delete pedidos[nombreAntiguo];
                } else {
                    pedidos[nombreFormateado] = pedidos[nombreAntiguo];
                    delete pedidos[nombreAntiguo];
                }
                
                database.ref('pedidos').set(pedidos);
                
                cerrarModal();
                alert('Nombre de la clienta actualizado correctamente.');
                mostrarResumen();
            } else if (nuevoNombre === nombreAntiguo) {
                alert('El nuevo nombre es igual al anterior.');
            } else {
                alert('Por favor, ingrese un nombre válido.');
            }
        }

        function enviarWhatsApp(clienta) {
            const telefono = clientasRegistradas[clienta];
            if (telefono) {
                let numeroLimpio = telefono.replace(/\D/g, '');
                
                if (!numeroLimpio.startsWith('52')) {
                    numeroLimpio = '52' + numeroLimpio;
                }
                
                if (numeroLimpio.length === 12) {
                    let mensaje = `Hola ${clienta}, aquí está el resumen de tu pedido:\n\n`;
                    let total = 0;

                    pedidos[clienta].forEach((pedido) => {
                        const subtotal = pedido.precio * pedido.cantidad;
                        total += subtotal;
                        
                        // Incluir información del color en el mensaje si existe
                        const colorInfo = pedido.color ? ` (${pedido.color})` : '';
                        
                        mensaje += `- ${pedido.producto}${colorInfo}: ${pedido.cantidad} x $${pedido.precio} = $${subtotal}\n`;
                    });

                    mensaje += `\nTotal a pagar: $${total}\n¡Gracias por tu compra!`;
                    const url = `https://wa.me/${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, '_blank');
                } else {
                    alert('El número de teléfono no tiene el formato correcto. Debe tener 10 dígitos.');
                }
            } else {
                alert('No hay número registrado para esta clienta.');
            }
        }

        function editarPedido(clienta, index) {
            const pedido = pedidos[clienta][index];
            const contenido = `
                <h3>Editar Pedido</h3>
                <p>${pedido.producto} - Precio: $${pedido.precio}</p>
                <input type="number" id="nuevaCantidad" value="${pedido.cantidad}" min="1">
                <input type="text" id="nuevoColor" value="${pedido.color || ''}" placeholder="Color (opcional)">
                <button onclick="guardarEdicion('${clienta}', ${index})">Guardar</button>
            `;
            abrirModal(contenido);
        }

        function guardarEdicion(clienta, index) {
            const nuevaCantidad = parseInt(document.getElementById('nuevaCantidad').value);
            const nuevoColor = document.getElementById('nuevoColor').value.trim();
            
            if (nuevaCantidad > 0) {
                pedidos[clienta][index].cantidad = nuevaCantidad;
                
                // Actualizar el color solo si se proporcionó uno
                if (nuevoColor) {
                    pedidos[clienta][index].color = nuevoColor;
                } else {
                    // Si el campo está vacío y existía un color, eliminarlo
                    if (pedidos[clienta][index].color) {
                        delete pedidos[clienta][index].color;
                    }
                }
                
                database.ref('pedidos').set(pedidos);
                cerrarModal();
                mostrarResumen();
            } else {
                alert('Ingrese una cantidad válida.');
            }
        }

        function confirmarReiniciarInventario() {
            const contenido = `
                <h3>Confirmar Reinicio</h3>
                <p>¿Está segura de que desea reiniciar TODO el inventario? Esta acción no se puede deshacer.</p>
                <button onclick="reiniciarInventario()">Sí, reiniciar</button>
            `;
            abrirModal(contenido);
        }

        function reiniciarInventario() {
            if (confirm('¿Estás segura de que deseas reiniciar TODO el inventario? Esta acción no se puede deshacer.')) {
                pedidos = {};
                database.ref('pedidos').set({});
                cerrarModal();
                mostrarResumen();
                alert('Inventario reiniciado correctamente. Las clientas registradas se mantienen.');
            }
        }

        function verProductosYClientas() {
            let productosMap = new Map();
            
            for (let clienta in pedidos) {
                pedidos[clienta].forEach(pedido => {
                    if (!productosMap.has(pedido.producto)) {
                        productosMap.set(pedido.producto, {
                            precio: pedido.precio,
                            clientas: new Map()
                        });
                    }
                    if (!productosMap.get(pedido.producto).clientas.has(clienta)) {
                        productosMap.get(pedido.producto).clientas.set(clienta, []);
                    }
                    productosMap.get(pedido.producto).clientas.get(clienta).push(pedidos[clienta].indexOf(pedido));
                });
            }

            let contenido = `
                <h3>Productos y Clientas</h3>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="buscarProducto" placeholder="Buscar producto..." style="margin-bottom: 10px;">
                    <button onclick="buscarProductoEnLista()" class="edit-button">Buscar</button>
                </div>
                <div id="listaProductos">
            `;
            
            // Guardar todos los productos en una variable global para la búsqueda
            window.todosLosProductos = new Map(productosMap);
            
            // Mostrar todos los productos inicialmente
            contenido += generarListaProductos(productosMap);
            contenido += '</div>';

            abrirModal(contenido);
        }

        // Función para generar la lista HTML de productos
        function generarListaProductos(productosMap) {
            let contenidoProductos = '';
            productosMap.forEach((info, producto) => {
                contenidoProductos += `
                    <div class="clienta-pedido">
                        <h4>${producto} - $${info.precio}</h4>
                        <p><strong>Ordenado por:</strong></p>
                        <button onclick="agregarClientaAProducto('${producto}', ${info.precio})" class="edit-button">Agregar Clienta</button>
                        <ul>
                `;
                
                info.clientas.forEach((indices, clienta) => {
                    indices.forEach(index => {
                        const pedido = pedidos[clienta][index];
                        // Mostrar el color si existe
                        const colorInfo = pedido.color ? ` (${pedido.color})` : '';
                        
                        contenidoProductos += `
                            <li>
                                ${clienta}${colorInfo} (${pedido.cantidad} unidades)
                                <button class="edit-button" onclick="editarNombreClientaEnPedido('${clienta}', ${index})">Corregir Nombre</button>
                                <button class="edit-button" onclick="eliminarPedidoDeClienta('${clienta}', ${index})">Eliminar</button>
                            </li>
                        `;
                    });
                });
                
                contenidoProductos += '</ul></div>';
            });
            return contenidoProductos;
        }

        // Función para buscar productos
        function buscarProductoEnLista() {
            const terminoBusqueda = document.getElementById('buscarProducto').value.trim().toLowerCase();
            const productosMap = window.todosLosProductos;
            
            if (!terminoBusqueda) {
                // Si no hay término de búsqueda, mostrar todos los productos
                document.getElementById('listaProductos').innerHTML = generarListaProductos(productosMap);
                return;
            }
            
            // Filtrar productos que coincidan con la búsqueda
            const productosFiltrados = new Map();
            
            productosMap.forEach((info, producto) => {
                if (producto.toLowerCase().includes(terminoBusqueda)) {
                    productosFiltrados.set(producto, info);
                }
            });
            
            // Actualizar la lista con los productos filtrados
            document.getElementById('listaProductos').innerHTML = 
                productosFiltrados.size > 0 
                    ? generarListaProductos(productosFiltrados) 
                    : '<p>No se encontraron productos que coincidan con la búsqueda.</p>';
        }

        function agregarClientaAProducto(producto, precio) {
            const contenido = `
                <h3>Agregar Clienta a ${producto}</h3>
                <input type="text" id="nombreClientaNueva" placeholder="Nombre de la clienta">
                <input type="number" id="cantidadProducto" placeholder="Cantidad" min="1" value="1">
                <input type="text" id="colorProducto" placeholder="Color (opcional)">
                <button onclick="guardarNuevaClientaEnProducto('${producto}', ${precio})">Agregar</button>
            `;
            abrirModal(contenido);
        }

        function guardarNuevaClientaEnProducto(producto, precio) {
            const nombre = document.getElementById('nombreClientaNueva').value.trim();
            const cantidad = parseInt(document.getElementById('cantidadProducto').value);
            const color = document.getElementById('colorProducto').value.trim();

            if (nombre && cantidad > 0) {
                const nombreFormateado = nombre.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');

                if (!pedidos[nombreFormateado]) {
                    pedidos[nombreFormateado] = [];
                }

                // Crear el objeto de pedido
                const nuevoPedido = {
                    producto: producto,
                    precio: precio,
                    cantidad: cantidad
                };

                // Agregar el color solo si se especificó
                if (color) {
                    nuevoPedido.color = color;
                }

                pedidos[nombreFormateado].push(nuevoPedido);

                database.ref('pedidos').set(pedidos);
                cerrarModal();
                verProductosYClientas();
            } else {
                alert('Por favor, ingrese un nombre válido y una cantidad mayor a 0.');
            }
        }

        function eliminarPedidoDeClienta(clienta, indexPedido) {
            if (confirm(`¿Estás segura de que deseas eliminar este pedido de ${clienta}?`)) {
                pedidos[clienta].splice(indexPedido, 1);
                
                if (pedidos[clienta].length === 0) {
                    delete pedidos[clienta];
                }

                database.ref('pedidos').set(pedidos);
                verProductosYClientas();
            }
        }

        function editarNombreClientaEnPedido(nombreAntiguo, indexPedido) {
            const pedido = pedidos[nombreAntiguo][indexPedido];
            const contenido = `
                <h3>Corregir Nombre de Clienta</h3>
                <p>Producto: ${pedido.producto} - Cantidad: ${pedido.cantidad}</p>
                <input type="text" id="nuevoNombreClienta" value="${nombreAntiguo}" placeholder="Nombre correcto de la clienta">
                <button onclick="guardarNombreCorregido('${nombreAntiguo}', ${indexPedido})">Guardar Corrección</button>
            `;
            abrirModal(contenido);
        }

        function guardarNombreCorregido(nombreAntiguo, indexPedido) {
            const nuevoNombre = document.getElementById('nuevoNombreClienta').value.trim();
            
            if (nuevoNombre && nuevoNombre !== nombreAntiguo) {
                const nombreFormateado = nuevoNombre.split(' ').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');

                const pedidoAMover = pedidos[nombreAntiguo][indexPedido];

                if (!pedidos[nombreFormateado]) {
                    pedidos[nombreFormateado] = [];
                }
                
                pedidos[nombreFormateado].push(pedidoAMover);
                pedidos[nombreAntiguo].splice(indexPedido, 1);

                if (pedidos[nombreAntiguo].length === 0) {
                    delete pedidos[nombreAntiguo];
                }

                database.ref('pedidos').set(pedidos);
                
                cerrarModal();
                alert('Nombre de la clienta corregido correctamente.');
                verProductosYClientas();
            } else if (nuevoNombre === nombreAntiguo) {
                alert('El nuevo nombre es igual al anterior.');
            } else {
                alert('Por favor, ingrese un nombre válido.');
            }
        }

        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            // Configuración de la página
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 5;
            const columnWidth = (pageWidth - (margin * 5)) / 4; // Dividir en 4 columnas
            const lineHeight = 4;

            // Título del documento
            doc.setFont("helvetica");
            doc.setFontSize(14);
            doc.text("Resumen de Pedidos - Ventas Mary", margin, margin + 4);

            let currentColumn = 0;
            let xPos = margin;
            let yPos = margin + 12;
            const startY = yPos;

            const clientas = Object.keys(pedidos);
            clientas.forEach((clienta, index) => {
                // Verificar si necesitamos cambiar de columna o página
                if (yPos > pageHeight - margin * 2) {
                    currentColumn++;
                    if (currentColumn >= 4) {
                        // Nueva página
                        doc.addPage();
                        currentColumn = 0;
                        xPos = margin;
                        yPos = startY;
                    } else {
                        // Siguiente columna
                        xPos = margin + (columnWidth + margin) * currentColumn;
                        yPos = startY;
                    }
                }

                // Nombre de la clienta
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text(clienta, xPos, yPos);
                yPos += lineHeight;

                // Detalles de pedidos
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                let total = 0;

                pedidos[clienta].forEach(pedido => {
                    const subtotal = pedido.precio * pedido.cantidad;
                    total += subtotal;
                    
                    // Agregar información del color si existe
                    const colorInfo = pedido.color ? `(${pedido.color}) ` : '';
                    const textoProducto = `${pedido.producto} ${colorInfo}- ${pedido.cantidad} x $${pedido.precio} = $${subtotal}`;
                    
                    // Dividir el texto si es muy largo
                    const splitText = doc.splitTextToSize(textoProducto, columnWidth - 2);
                    splitText.forEach(line => {
                        doc.text(line, xPos + 2, yPos);
                        yPos += lineHeight;
                    });
                });

                // Total
                doc.setFont("helvetica", "bold");
                doc.text(`Total: $${total}`, xPos + 2, yPos);
                yPos += lineHeight * 1.5;
            });

            doc.save('Ventas_Mary_Pedidos.pdf');
        }

        function calcularEstadisticasActuales() {
            let ventasTotales = 0;
            let totalProductos = 0;
            let productosConteo = {};
            let clientasCompras = {};

            // Calcular estadísticas
            for (let clienta in pedidos) {
                clientasCompras[clienta] = 0;
                
                pedidos[clienta].forEach(pedido => {
                    const subtotal = pedido.precio * pedido.cantidad;
                    ventasTotales += subtotal;
                    totalProductos += pedido.cantidad;
                    clientasCompras[clienta] += subtotal;

                    if (!productosConteo[pedido.producto]) {
                        productosConteo[pedido.producto] = 0;
                    }
                    productosConteo[pedido.producto] += pedido.cantidad;
                });
            }

            // Encontrar producto más vendido
            let productoMasVendido = '-';
            let maxCantidad = 0;
            for (let producto in productosConteo) {
                if (productosConteo[producto] > maxCantidad) {
                    maxCantidad = productosConteo[producto];
                    productoMasVendido = producto;
                }
            }
            
            // Encontrar clienta que más compró
            let clientaMasCompro = '-';
            let maxCompra = 0;
            for (let clienta in clientasCompras) {
                if (clientasCompras[clienta] > maxCompra) {
                    maxCompra = clientasCompras[clienta];
                    clientaMasCompro = clienta;
                }
            }

            // Guardar estadísticas de la semana
            const semanaActual = moment().format('YYYY-[W]ww');
            if (!estadisticasSemanales[semanaActual]) {
                estadisticasSemanales[semanaActual] = {
                    ventasTotales,
                    totalProductos,
                    clientasActivas: Object.keys(pedidos).length,
                    productoMasVendido,
                    clientaMasCompro,
                    totalClientaMasCompro: maxCompra,
                    productosVendidos: productosConteo,
                    fecha: moment().format()
                };
                database.ref('estadisticasSemanales').set(estadisticasSemanales);
            }

            return {
                ventasTotales,
                totalProductos,
                clientasActivas: Object.keys(pedidos).length,
                productoMasVendido,
                clientaMasCompro,
                totalClientaMasCompro: maxCompra
            };
        }

        function abrirModalEstadisticas() {
            const contenido = `
                <div class="estadisticas-container">
                    <h3>Estadísticas de Ventas</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Ventas Totales</div>
                            <div class="stat-value" id="ventasTotales">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Productos Vendidos</div>
                            <div class="stat-value" id="productosVendidos">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Clientas Activas</div>
                            <div class="stat-value" id="clientasActivas">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Producto Más Vendido</div>
                            <div class="stat-value" id="productoMasVendido">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Clienta Que Más Compró</div>
                            <div class="stat-value" id="clientaMasCompro">-</div>
                            <div class="stat-sublabel" id="totalClientaMasCompro">$0</div>
                        </div>
                    </div>

                    <div class="date-selector">
                        <button onclick="cambiarPeriodo('anterior')">&lt; Anterior</button>
                        <span id="periodoActual">Semana Actual</span>
                        <button onclick="cambiarPeriodo('siguiente')">Siguiente &gt;</button>
                    </div>

                    <div class="chart-selector">
                        <button onclick="cambiarGrafico('ventas')" class="active">Ventas</button>
                        <button onclick="cambiarGrafico('productos')">Productos</button>
                        <button onclick="cambiarGrafico('clientas')">Clientas</button>
                    </div>

                    <div class="chart-container">
                        <canvas id="estadisticasChart"></canvas>
                    </div>
                </div>
            `;
            abrirModal(contenido);
            inicializarEstadisticas();
        }

        function inicializarEstadisticas() {
            // Configurar fecha actual
            moment.locale('es');
            const fechaActual = moment();
            document.getElementById('periodoActual').textContent = `Semana del ${fechaActual.startOf('week').format('D MMM')} al ${fechaActual.endOf('week').format('D MMM')}`;

            // Calcular estadísticas
            const stats = calcularEstadisticasActuales();
            
            // Actualizar valores en las tarjetas
            document.getElementById('ventasTotales').textContent = `$${stats.ventasTotales}`;
            document.getElementById('productosVendidos').textContent = stats.totalProductos;
            document.getElementById('clientasActivas').textContent = stats.clientasActivas;
            document.getElementById('productoMasVendido').textContent = stats.productoMasVendido;
            document.getElementById('clientaMasCompro').textContent = stats.clientaMasCompro;
            document.getElementById('totalClientaMasCompro').textContent = `$${stats.totalClientaMasCompro}`;

            // Inicializar gráfico
            crearGraficoVentas();
        }

        function crearGraficoVentas() {
            const ctx = document.getElementById('estadisticasChart').getContext('2d');
            
            // Destruir gráfico existente si hay uno
            if (graficosEstadisticas.chart) {
                graficosEstadisticas.chart.destroy();
            }

            // Preparar datos para el gráfico
            const semanas = Object.keys(estadisticasSemanales).sort();
            const datos = semanas.map(semana => estadisticasSemanales[semana].ventasTotales);
            const labels = semanas.map(semana => {
                const fecha = moment(estadisticasSemanales[semana].fecha);
                return `Semana del ${fecha.startOf('week').format('D MMM')}`;
            });

            graficosEstadisticas.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Totales',
                        data: datos,
                        borderColor: '#FF69B4',
                        backgroundColor: 'rgba(255, 105, 180, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Tendencia de Ventas por Semana'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function cambiarGrafico(tipo) {
            // Actualizar botones
            document.querySelectorAll('.chart-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const ctx = document.getElementById('estadisticasChart').getContext('2d');
            if (graficosEstadisticas.chart) {
                graficosEstadisticas.chart.destroy();
            }

            const semanaActual = moment().format('YYYY-[W]ww');
            const datos = estadisticasSemanales[semanaActual];

            let configuracion;
            switch(tipo) {
                case 'ventas':
                    crearGraficoVentas();
                    return;
                case 'productos':
                    const productosData = Object.entries(datos.productosVendidos)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    configuracion = {
                        type: 'bar',
                        data: {
                            labels: productosData.map(p => p[0]),
                            datasets: [{
                                label: 'Cantidad Vendida',
                                data: productosData.map(p => p[1]),
                                backgroundColor: '#FF69B4',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Productos Más Vendidos'
                                }
                            }
                        }
                    };
                    break;
                case 'clientas':
                    const clientasData = Object.keys(pedidos).length;
                    configuracion = {
                        type: 'doughnut',
                        data: {
                            labels: ['Clientas Activas', 'Meta'],
                            datasets: [{
                                data: [clientasData, Math.max(20, clientasData * 1.5)],
                                backgroundColor: ['#FF69B4', '#FFE4E1']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Clientas Activas vs Meta'
                                }
                            }
                        }
                    };
                    break;
            }

            graficosEstadisticas.chart = new Chart(ctx, configuracion);
        }

        function cambiarPeriodo(direccion) {
            const periodoActualElement = document.getElementById('periodoActual');
            const fechaActual = moment(periodoActualElement.textContent, 'Semana del D MMM al D MMM');
            
            if (direccion === 'anterior') {
                fechaActual.subtract(1, 'week');
            } else {
                fechaActual.add(1, 'week');
            }

            periodoActualElement.textContent = `Semana del ${fechaActual.startOf('week').format('D MMM')} al ${fechaActual.endOf('week').format('D MMM')}`;
            
            // Actualizar gráficos con los datos de la nueva semana
            const semanaSeleccionada = fechaActual.format('YYYY-[W]ww');
            if (estadisticasSemanales[semanaSeleccionada]) {
                actualizarEstadisticasConPeriodo(semanaSeleccionada);
            } else {
                // Si no hay datos para esa semana, mostrar valores en cero
                document.getElementById('ventasTotales').textContent = '$0';
                document.getElementById('productosVendidos').textContent = '0';
                document.getElementById('clientasActivas').textContent = '0';
                document.getElementById('productoMasVendido').textContent = '-';
                document.getElementById('clientaMasCompro').textContent = '-';
                document.getElementById('totalClientaMasCompro').textContent = '$0';
            }
        }

        function actualizarEstadisticasConPeriodo(semana) {
            const datos = estadisticasSemanales[semana];
            if (datos) {
                document.getElementById('ventasTotales').textContent = `$${datos.ventasTotales}`;
                document.getElementById('productosVendidos').textContent = datos.totalProductos;
                document.getElementById('clientasActivas').textContent = datos.clientasActivas;
                document.getElementById('productoMasVendido').textContent = datos.productoMasVendido;
                
                // Actualizar información de la clienta que más compró
                if (datos.clientaMasCompro) {
                    document.getElementById('clientaMasCompro').textContent = datos.clientaMasCompro;
                    document.getElementById('totalClientaMasCompro').textContent = `$${datos.totalClientaMasCompro}`;
                } else {
                    document.getElementById('clientaMasCompro').textContent = '-';
                    document.getElementById('totalClientaMasCompro').textContent = '$0';
                }
                
                // Actualizar el gráfico activo
                const tipoActivo = document.querySelector('.chart-selector button.active').textContent.toLowerCase();
                cambiarGrafico(tipoActivo);
            }
        }
    </script>
</body>
</html>
